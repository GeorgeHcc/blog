(window.webpackJsonp=window.webpackJsonp||[]).push([[39],{369:function(s,a,t){"use strict";t.r(a);var e=t(4),n=Object(e.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("p",[s._v("这节课我们来说说 Coturn 网络打洞服务器， Coturn 是一个开源的 TURN & STUN 服务器，"),a("a",{attrs:{href:"https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fcoturn%2Fcoturn",target:"_blank",rel:"noopener noreferrer"}},[s._v("Github地址"),a("OutboundLink")],1),s._v("。")]),s._v(" "),a("p",[s._v("这里又扯到了 TURN 和 STUN 两个特别的东西，在具体介绍这两个名词的知识前，我们先看看在用 "),a("code",[s._v("WebRTC")]),s._v("进行视频通话过程中会遇到什么问题。")]),s._v(" "),a("p",[s._v("需要知道的是， "),a("code",[s._v("WebRTC")]),s._v("进行通话过程中是没有任何视频服务器的，所有的 RTP 数据包都是直接通过双方的 IP 和对应的端口进行发送和传输的（大家感兴趣的话，可以尝试用 GB28181 和监控摄像头交互然后获取监控的 RTP 包 ）。")]),s._v(" "),a("p",[s._v("因此通常在开始通话之前，就必须进行 ICE 协商获取双方的 IP 以及端口，如果通话是区域网则简单，直接区域网 IP 即可，但通话如果是在公共复杂网络，且客户端并未直接接入公共网路，而是仅接入到本地 "),a("code",[s._v("NAT 网关")]),s._v("中呢？")]),s._v(" "),a("p",[s._v("此时是无法直接获取通话客户端的公有 IP 的。这个时候就需要特定的东西去"),a("strong",[s._v("获取客户端真实且互相可以抵达的公有 IP")]),s._v("，而 STUN 服务器的作用就是干这个的，有了它就可以让通话双方发现对方的公共通讯地址。")]),s._v(" "),a("p",[s._v("接上面，能发现公有地址不代表就能进行通话，进行通话的前提是允许客户端能够在相应端口进行上行和下行数据的发送和接收。就好比你电脑启动了一个服务但是防火墙是开着的，那么别人访问你的服务还是没法访问的。此时 TURN 来了，"),a("strong",[s._v("它的作用就是充当双方中继地址，将双方的流量中继到当前服务器从而实现双方流量的交换")]),s._v("。")]),s._v(" "),a("h2",{attrs:{id:"打洞服务器的搭建"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#打洞服务器的搭建"}},[s._v("#")]),s._v(" "),a("strong",[s._v("打洞服务器的搭建")])]),s._v(" "),a("p",[s._v("为了让大家免于各种复杂环境的困扰，我们使用容器来搭建。")]),s._v(" "),a("ol",[a("li",[a("p",[s._v("首先提前下载对应的配置文件："),a("a",{attrs:{href:"https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fcoturn%2Fcoturn%2Fblob%2Fmaster%2Fdocker%2Fcoturn%2Fturnserver.conf",target:"_blank",rel:"noopener noreferrer"}},[s._v("官方文件"),a("OutboundLink")],1),s._v("。")])]),s._v(" "),a("li",[a("p",[s._v("修改重要的配置，"),a("strong",[s._v("注意不是替换，是找到下面配置的地址")]),s._v("，注意看每个配置的描述。")])])]),s._v(" "),a("blockquote",[a("p",[s._v("在纯内网环境，很多时候服务器只有一个 IP ，因此下面遇到的 IP 配置都配置同一个，而 realm 使用默认即可，无需配置。")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("shell复制代码"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#中继服务器监听的IP地址，可以指定多个IP  最好直接写 ip addr  输出的etho的ip")]),s._v("\nlistening-ip"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.0")]),s._v(".4.3\nlistening-port"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3478")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#中继服务器转发地址(本地IP地址将用于传递数据包的给每个端)，最好直接写 ip addr 输出的eth1的ip,不存在则直接公网IP")]),s._v("\nrelay-ip"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.0")]),s._v(".4.3\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#外部IP,直接写公网IP地址")]),s._v("\nexternal-ip"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("115.15")]),s._v(".172.71\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 中继线程，如果服务器资源充足可以适当扩大，最大不能超过 50")]),s._v("\nrelay-threads"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#打开密码验证，使用短期证书机制。")]),s._v("\nlt-cred-mech\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#UDP端口 下面默认就有 可以自定义自己想要的区间 这个就是中继流量转发的端口")]),s._v("\nmin-port"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("17001")]),s._v("\nmax-port"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("19001")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#turn服务器的用户和凭据")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("user")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("suke:suke119119\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#打开下面DB关闭mysql DB ，")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("userdb")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/var/lib/coturn/turndb\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("##mysql-userdb xxxxxxxxxxxxxxxxxxx ##注释")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 这里可以不用管，公网需要的则可以配置对应的域名")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("realm")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("example.cn \n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 配置日志输出，用户后面直接重定向到容器日志")]),s._v("\nlog-file"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("stdout "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 注释 sys-log ")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br")])]),a("ol",[a("li",[s._v("挂载配置文件位置启动容器。")])]),s._v(" "),a("blockquote",[a("p",[s._v("Coturn 我这里指定的镜像为 4.6 版本的，如果有新的，大家可以尝试最新稳定版本。")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("shell复制代码sudo "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" run "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-d")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--privileged")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--name")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("mycoturn   "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--network")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("host "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n           "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-v")]),s._v(" /home/ubuntu/turnserver/turnserver.conf:/my/turnserver.conf "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n       coturn/coturn:4.6 "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-c")]),s._v(" /my/turnserver.conf \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("ol",[a("li",[s._v("日志。")])]),s._v(" "),a("blockquote",[a("p",[s._v("下面的 167.160.189.179 IP 为我搭建的启动成功后的日志。")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("shell复制代码root@C20220407114397:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker logs -f mycoturn")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" Listener address to use: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("167.160")]),s._v(".189.179\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" Listener address to use: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("167.160")]),s._v(".189.179\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" Relay address to use: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("167.160")]),s._v(".189.179\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" \nRFC "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3489")]),s._v("/5389/5766/5780/6062/6156 STUN/TURN Server\nVersion Coturn-4.6.0 "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Gorst'")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" \nMax number of "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("open")]),s._v(" files/sockets allowed "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" this process: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1048576")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" \nDue to the "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("open")]),s._v(" files/sockets limitation,\nmax supported number of TURN Sessions possible is: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("524000")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("approximately"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" \n\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" Show him the instruments, Practical Frost: "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" TLS supported\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" DTLS supported\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" DTLS "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.2")]),s._v(" supported\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" TURN/STUN ALPN supported\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" Third-party authorization "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("oAuth"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" supported\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" GCM "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("AEAD"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" supported\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" OpenSSL compile-time version: OpenSSL "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.1")]),s._v(".1n  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(" Mar "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("0x101010ef"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" \n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" SQLite supported, default database location is /var/lib/coturn/turndb\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" Redis supported\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" PostgreSQL supported\nCannot create pid file: /var/run/turnserver.pid: Permission denied\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" MySQL supported\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" MongoDB supported\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" \n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" Default Net Engine version: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("UDP thread per CPU core"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" Domain name: \n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" Default realm: example.org\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" WARNING: cannot "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("find")]),s._v(" certificate file: /etc/ssl/certs/cert.pem "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" WARNING: cannot start TLS and DTLS listeners because certificate "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" is not "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" properly\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" WARNING: cannot "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("find")]),s._v(" private key file: /etc/ssl/private/privkey.pem "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" WARNING: cannot start TLS and DTLS listeners because private key "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" is not "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" properly\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" Cannot create pid file: /var/run/turnserver.pid\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" pid "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" created: /var/tmp/turnserver.pid\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" IO method "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("main listener thread"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(": epoll "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("with changelist"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" WARNING: I cannot support STUN CHANGE_REQUEST functionality because only one IP address is provided\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" Wait "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" relay ports initialization"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v("   relay "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("167.160")]),s._v(".189.179 initialization"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v("   relay "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("167.160")]),s._v(".189.179 initialization "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("done")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" Relay ports initialization "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("done")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" IO method "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("general relay thread"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(": epoll "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("with changelist"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" turn server "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("id")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" created\nYou must obtain superuser privileges to "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("bind")]),s._v(" a socket to device: Operation not permitted\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" Cannot "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("bind")]),s._v(" listener socket to device ens17\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" IPv4. SCTP listener opened on "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("167.160")]),s._v(".189.179:3478\nYou must obtain superuser privileges to "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("bind")]),s._v(" a socket to device: Operation not permitted\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" Cannot "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("bind")]),s._v(" listener socket to device ens17\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" IPv4. TCP listener opened on "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("167.160")]),s._v(".189.179:3478\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" IO method "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("general relay thread"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(": epoll "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("with changelist"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" turn server "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("id")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" created\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" Total General servers: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" IO method "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("auth thread"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(": epoll "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("with changelist"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" IO method "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("admin thread"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(": epoll "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("with changelist"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" IO method "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("auth thread"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(": epoll "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("with changelist"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" IPv4. CLI listener opened on "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:5766\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" SQLite DB connection success: /var/lib/coturn/turndb\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" Prometheus collector disabled, not started.\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br"),a("span",{staticClass:"line-number"},[s._v("59")]),a("br"),a("span",{staticClass:"line-number"},[s._v("60")]),a("br"),a("span",{staticClass:"line-number"},[s._v("61")]),a("br"),a("span",{staticClass:"line-number"},[s._v("62")]),a("br"),a("span",{staticClass:"line-number"},[s._v("63")]),a("br"),a("span",{staticClass:"line-number"},[s._v("64")]),a("br"),a("span",{staticClass:"line-number"},[s._v("65")]),a("br"),a("span",{staticClass:"line-number"},[s._v("66")]),a("br")])]),a("ol",[a("li",[s._v("测试是否成功。")])]),s._v(" "),a("p",[s._v("最简单的方法是直接在浏览器输入服务器 "),a("code",[s._v("IP:3478")]),s._v("，然后看输出日志，如果输出以下类似日志，则大概率部署成功。")]),s._v(" "),a("blockquote",[a("p",[s._v("可以注意到日志中 username 的值。")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("shell复制代码86396: "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" session 001000000000000001: usage: "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("realm")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("example.org"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("username")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<>")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("rp")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("rb")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("sp")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("sb")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("88")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("86396")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" session 001000000000000001: peer usage: "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("realm")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("example.org"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("username")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<>")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("rp")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("rb")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("sp")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("sb")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("86396")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" session 001000000000000001: closed "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("2nd stage"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", user "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<>")]),s._v(" realm "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("example.org"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" origin "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<>")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("local")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("167.160")]),s._v(".189.179:3478, remote "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("146.88")]),s._v(".240.4:36837, reason: allocation watchdog determined stale session state\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("98891")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" session 001000000000000002: usage: "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("realm")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("example.org"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("username")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<>")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("rp")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("rb")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("sp")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("sb")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("88")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("98891")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" session 001000000000000002: peer usage: "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("realm")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("example.org"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("username")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<>")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("rp")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("rb")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("sp")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("sb")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("98891")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" session 001000000000000002: closed "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("2nd stage"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", user "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<>")]),s._v(" realm "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("example.org"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" origin "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<>")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("local")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("167.16")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("h2",{attrs:{id:"项目中使用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#项目中使用"}},[s._v("#")]),s._v(" "),a("strong",[s._v("项目中使用")])]),s._v(" "),a("ol",[a("li",[s._v("代码配置")])]),s._v(" "),a("p",[a("strong",[s._v("iceTransportPolicy")]),s._v(" 配置表示所有配置此参数的客户端在通话的时候都走 Turn 服务器中继。")]),s._v(" "),a("div",{staticClass:"language-javascript line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[s._v("javascript复制代码"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//全局变量")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("rtcPcParams")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("iceTransportPolicy")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'relay'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//强制走中继")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("iceServers")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n             "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("urls")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'turn:167.160.189.179:3478'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("username")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'suc'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token literal-property property"}},[s._v("credential")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'suc001'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    \n "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//初始化RTC和核心对象时配置此参数")]),s._v("\n "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("let")]),s._v(" pc "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("PeerConnection")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("that"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("rtcPcParams"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("ol",[a("li",[s._v("中继日志")])]),s._v(" "),a("blockquote",[a("p",[s._v("注意看 username 字段以及后面的 incoming packet。")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("shell复制代码519121: "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" session 000000000000000016: delete: "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("realm")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("example.org"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("username")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("suc"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("519212")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" session 000000000000000017: peer "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".0.49 lifetime updated: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("600")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("519212")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" session 000000000000000017: realm "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("example.org"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" user "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("suc"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(": incoming packet CHANNEL_BIND processed, success\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("519212")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" session 001000000000000026: peer "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".0.49 lifetime updated: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("600")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("519212")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" session 001000000000000026: realm "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("example.org"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" user "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("suc"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(": incoming packet CHANNEL_BIND processed, success\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("519272")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" session 001000000000000026: refreshed, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("realm")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("example.org"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("username")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("suc"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("lifetime")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("600")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("519272")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" session 001000000000000026: realm "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("example.org"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" user "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("suc"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(": incoming packet REFRESH processed, success\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("519272")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" session 000000000000000017: refreshed, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("realm")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("example.org"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("username")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("suc"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("lifetime")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("600")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("519272")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" session 000000000000000017: realm "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("example.org"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" user "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("suc"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(": incoming packet REFRESH processed, success\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("519452")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" session 001000000000000026: realm "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("example.org"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("h2",{attrs:{id:"温馨提示"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#温馨提示"}},[s._v("#")]),s._v(" 温馨提示")]),s._v(" "),a("p",[s._v("从前面的代码配置和部署中，我们基本上看到的只有 TURN 服务的配置和使用，中间并没有提到 STUN ，实际上在你部署启动 Coturn 服务的那一刻起，当前服务就已经支持 STUN 了，大家可以看启动成功的日志：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7f858be7dc574d94a1962bacadb7e93b~tplv-k3u1fbpfcp-jj-mark:1890:0:0:0:q75.awebp",alt:"img"}})]),s._v(" "),a("p",[s._v("因此如果你的 TURN 服务已经没问题了，那么 STUN 服务必然没有问题的，在你的代码中配置的时候，你可以同时配置 STUN 和 TURN 服务，我代码中为了演示，并没有使用 STUN 服务，因为我不想让网络流量都走自己的网络，而是走 TURN 服务，如此我就可以直观地看到流量包的走向。")]),s._v(" "),a("p",[s._v("在实际场景中，尤其涉及到网络比较严格或者不容易抵达，尤其是防火墙限制很严重的情况下，此时我也是建议单独使用性能较好的服务器部署 Coturn 服务，让所有的流量全部都中继服务器，避免 ICE 协商失败导致无法进行通话。")]),s._v(" "),a("h2",{attrs:{id:"课后作业"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#课后作业"}},[s._v("#")]),s._v(" 课后作业")]),s._v(" "),a("p",[s._v("本节课，我们主要讨论了复杂的网络环境中如何使用打洞服务器保证通话成功率，课后大家试试在多人会议聊天的时候强制中继配置后，TURN 服务器的性能变化以及网络流量的变化。以及关闭该服务器后视频通话能否再进行呢？")])])}),[],!1,null,null,null);a.default=n.exports}}]);